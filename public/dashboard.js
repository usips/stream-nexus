(()=>{"use strict";const e=document.querySelector("#chat-history"),t=document.querySelector("#donation-history"),n=document.querySelector("#connection-status");let o=!0,s=!0;const a=new Set;function l(e,t){e&&e.addEventListener("scroll",()=>{const n=e.scrollHeight-e.scrollTop-e.clientHeight<50;t(n)})}function i(e,t){e&&t&&(e.scrollTop=e.scrollHeight)}function c(e){const t=Math.floor(Date.now()/1e3)-e;if(t<60)return"just now";if(t<3600)return`${Math.floor(t/60)}m ago`;if(t<86400){const e=Math.floor(t/3600),n=Math.floor(t%3600/60);return n>0?`${e}h ${n}m ago`:`${e}h ago`}{const e=Math.floor(t/86400),n=Math.floor(t%86400/3600);return n>0?`${e}d ${n}h ago`:`${e}d ago`}}l(e,e=>{o=e}),l(t,e=>{s=e}),setInterval(function(){document.querySelectorAll("[data-timestamp]").forEach(e=>{const t=parseInt(e.dataset.timestamp||"0",10);t>0&&(e.textContent=c(t))})},3e4);class r{constructor(e,t,n){this.id=e,this.platform=t,this.channel=n,this.sent_at=Math.round(Date.now()/1e3),this.received_at=Math.round(Date.now()/1e3),this.message="",this.html="",this.emojis=[],this.username="DUMMY_USER",this.avatar="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",this.amount=0,this.currency="ZWL",this.is_placeholder=!1,this.is_verified=!1,this.is_sub=!1,this.is_mod=!1,this.is_owner=!1,this.is_staff=!1}}const d=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/chat.ws`;let u=null;function m(e){n&&(n.classList.toggle("connected",e),n.textContent=e?"Connected":"Disconnected")}function h(e=1){const t=document.querySelector("#poll-options");if(t)for(let n=0;n<e;n++){const e=document.createElement("input");e.setAttribute("type","text"),e.setAttribute("placeholder","Poll option"),e.setAttribute("class","poll-option"),e.addEventListener("keydown",f),e.addEventListener("blur",g),t.appendChild(e)}}function f(e){const t=document.querySelectorAll(".poll-option");if(t.length>=15)return;const n=t[t.length-1];n&&""!==n.value&&h()}function g(e){if(document.querySelectorAll(".poll-option").length<=2)return;const t=e.target;""===t.value&&t.remove()}function p(){const e=this.id;this.classList.contains("msg--sticky")?y(null):(y(e),a.add(e),this.classList.add("msg--was-featured"))}function y(e){console.log("Featuring message:",e);const t={feature_message:e};u?.send(JSON.stringify(t))}function w(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function E(e){const t={platform:"none",messages:[e]};u?.send(JSON.stringify(t))}function A(e,t=!1){const n=new r(w(),"none","none");n.message=e,n.is_owner=t,E(n)}function x(e,t){const n=document.createElement("span");n.className="superchat-time",n.dataset.timestamp=t.toString(),n.textContent=c(t);const o=e.querySelector(".msg-container")||e;o.insertBefore(n,o.firstChild)}!function(){u=new WebSocket(d);const n=()=>!(!u||u.readyState!==WebSocket.OPEN&&u.readyState!==WebSocket.CONNECTING)||(u=new WebSocket(d),l(),!1),l=()=>{u&&(u.addEventListener("open",()=>{console.log("[Dashboard] Connection established."),m(!0)}),u.addEventListener("message",n=>{const l=JSON.parse(n.data),c=JSON.parse(l.message);switch(l.tag){case"chat_message":!function(n){if(n.is_placeholder)return null;const l=document.getElementById(n.id);if(null!==l)return l;const c=document.createElement("div");if(n.amount>0){if(t){t.appendChild(c),c.outerHTML=n.html;const e=document.getElementById(n.id);e&&(x(e,n.sent_at),e.addEventListener("click",p),a.has(n.id)&&e.classList.add("msg--was-featured")),i(t,s)}}else if(e){for(e.appendChild(c),c.outerHTML=n.html;e.children.length>500;){const t=e.firstElementChild;if(!t||t.classList.contains("msg--sticky"))break;t.remove()}const t=document.getElementById(n.id);t&&(t.addEventListener("click",p),a.has(n.id)&&t.classList.add("msg--was-featured")),i(e,o)}}(c);break;case"feature_message":!function(e){if(document.querySelectorAll(".msg--sticky").forEach(e=>{e.classList.remove("msg--sticky")}),e){const t=document.getElementById(e);null!==t&&(t.classList.add("msg--sticky"),a.add(e),t.classList.add("msg--was-featured"))}}(c);break;case"viewers":break;default:console.log("Unknown tag:",l.tag)}}),u.addEventListener("close",e=>{console.log("[Dashboard] Socket closed. Attempting reconnect.",e.reason),m(!1),setTimeout(()=>{n()},3e3)}),u.addEventListener("error",()=>{u?.close(),m(!1),setTimeout(()=>{n()},3e3)}))};l()}(),document.querySelectorAll(".msg").forEach(e=>{e.addEventListener("click",p),e.closest("#donation-history")&&x(e,parseInt(e.dataset.sentAt||"0",10)||Math.floor(Date.now()/1e3))}),document.querySelectorAll(".poll-option").forEach(e=>{e.addEventListener("keydown",f),e.addEventListener("blur",g)}),window.newPollOption=h,window.onPollOptionType=f,window.onPollOptionChange=g,window.onPollCreate=function(){const e=document.getElementById("multiplechoice"),t=document.getElementById("pollquestion"),n=e?.checked?"multipoll":"poll",o=document.querySelectorAll(".poll-option"),s=[],a=t?.value||"";o.forEach(e=>{""!==e.value&&s.push(e.value)}),s.length<2?alert("You need at least two poll options."):""!==a?(A(`!${n} ${a}; ${s.join("; ")}`),function(){const e=document.getElementById("pollquestion");e&&(e.value=""),document.querySelectorAll(".poll-option").forEach(e=>{e.remove()}),h(2)}()):alert("You need a poll question.")},window.onPollEnd=function(){A("!endpoll",!0)},window.sendPaidMessage=function(){const e=new r(w(),"none","none"),t=document.getElementById("donation-platform"),n=document.getElementById("donation-username"),o=document.getElementById("donation-amount"),s=document.getElementById("donation-currency"),a=document.getElementById("donation-message");switch(e.platform=t?.value||"none",e.username=n?.value||"Anonymous",e.amount=parseFloat(o?.value||"0"),e.currency=s?.value||"USD",e.message=a?.value||"",e.platform){case"mail":case"usps":e.avatar="/static/logo/usps.png"}E(e)},window.sendSimpleMessage=A})();