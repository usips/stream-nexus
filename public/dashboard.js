(()=>{"use strict";const e=document.querySelector("#chat-history"),t=document.querySelector("#donation-history"),n=document.querySelector("#connection-status");let o=!0,s=!0;const l=new Set;function a(e){const t=document.createElement("button");t.className="scroll-to-bottom",t.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z" transform="rotate(90 12 12)"/></svg>',t.title="Scroll to bottom",t.style.display="none";const n=e.closest(".dashboard-column");return n&&(n.style.position="relative",n.appendChild(t)),t}function c(e,t,n){if(!e)return;const o=()=>{const o=function(e){return e.scrollHeight-e.scrollTop-e.clientHeight<100}(e);t(o),n&&(n.style.display=o?"none":"flex")};e.addEventListener("scroll",o),setInterval(o,1e3)}function i(e,t){e&&t&&(e.scrollTop=e.scrollHeight)}function r(e,t){e&&(e.scrollTop=e.scrollHeight,t&&(t.style.display="none"))}const d=e?a(e):null,u=t?a(t):null;function m(e){const t=Math.floor(Date.now()/1e3)-e;if(t<60)return"just now";if(t<3600)return`${Math.floor(t/60)}m ago`;if(t<86400){const e=Math.floor(t/3600),n=Math.floor(t%3600/60);return n>0?`${e}h ${n}m ago`:`${e}h ago`}{const e=Math.floor(t/86400),n=Math.floor(t%86400/3600);return n>0?`${e}d ${n}h ago`:`${e}d ago`}}c(e,e=>{o=e},d),c(t,e=>{s=e},u),d&&e&&d.addEventListener("click",()=>{o=!0,r(e,d)}),u&&t&&u.addEventListener("click",()=>{s=!0,r(t,u)}),setInterval(function(){document.querySelectorAll("[data-timestamp]").forEach(e=>{const t=parseInt(e.dataset.timestamp||"0",10);t>0&&(e.textContent=m(t))})},3e4);class h{constructor(e,t,n){this.id=e,this.platform=t,this.channel=n,this.sent_at=Math.round(Date.now()/1e3),this.received_at=Math.round(Date.now()/1e3),this.message="",this.html="",this.emojis=[],this.username="DUMMY_USER",this.avatar="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",this.amount=0,this.currency="ZWL",this.is_placeholder=!1,this.is_verified=!1,this.is_sub=!1,this.is_mod=!1,this.is_owner=!1,this.is_staff=!1}}const f=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/chat.ws`;let g=null;function p(e){n&&(n.classList.toggle("connected",e),n.textContent=e?"Connected":"Disconnected")}function y(e=1){const t=document.querySelector("#poll-options");if(t)for(let n=0;n<e;n++){const e=document.createElement("input");e.setAttribute("type","text"),e.setAttribute("placeholder","Poll option"),e.setAttribute("class","poll-option"),e.addEventListener("keydown",w),e.addEventListener("blur",E),t.appendChild(e)}}function w(e){const t=document.querySelectorAll(".poll-option");if(t.length>=15)return;const n=t[t.length-1];n&&""!==n.value&&y()}function E(e){if(document.querySelectorAll(".poll-option").length<=2)return;const t=e.target;""===t.value&&t.remove()}function v(){const e=this.id;this.classList.contains("msg--sticky")?x(null):(x(e),l.add(e),this.classList.add("msg--was-featured"))}function x(e){console.log("Featuring message:",e);const t={feature_message:e};g?.send(JSON.stringify(t))}function A(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function S(e){const t={platform:"none",messages:[e]};g?.send(JSON.stringify(t))}function L(e,t=!1){const n=new h(A(),"none","none");n.message=e,n.is_owner=t,S(n)}function k(e,t){const n=document.createElement("span");n.className="superchat-time",n.dataset.timestamp=t.toString(),n.textContent=m(t);const o=e.querySelector(".msg-amount");if(o)o.appendChild(n);else{const t=e.querySelector(".msg-container")||e;t.insertBefore(n,t.firstChild)}}!function(){g=new WebSocket(f);const n=()=>!(!g||g.readyState!==WebSocket.OPEN&&g.readyState!==WebSocket.CONNECTING)||(g=new WebSocket(f),a(),!1),a=()=>{g&&(g.addEventListener("open",()=>{console.log("[Dashboard] Connection established."),p(!0),g?.send(JSON.stringify({request_messages:!0}))}),g.addEventListener("message",n=>{const a=JSON.parse(n.data),c=JSON.parse(a.message);switch(a.tag){case"chat_message":!function(n){if(n.is_placeholder)return null;const a=document.getElementById(n.id);if(null!==a)return a;const c=document.createElement("div");if(n.amount>0){if(t){t.appendChild(c),c.outerHTML=n.html;const e=document.getElementById(n.id);e&&(k(e,Math.floor(n.sent_at/1e3)),e.addEventListener("click",v),l.has(n.id)&&e.classList.add("msg--was-featured")),i(t,s)}}else if(e){e.appendChild(c),c.outerHTML=n.html;const t=300;if(e.children.length>t){const n=[];for(let o=0;o<e.children.length-t;o++){const t=e.children[o];t.classList.contains("msg--sticky")||n.push(t)}for(const e of n)e.remove()}const s=document.getElementById(n.id);s&&(s.addEventListener("click",v),l.has(n.id)&&s.classList.add("msg--was-featured")),i(e,o)}}(c);break;case"feature_message":!function(e){if(document.querySelectorAll(".msg--sticky").forEach(e=>{e.classList.remove("msg--sticky")}),e){const t=document.getElementById(e);null!==t&&(t.classList.add("msg--sticky"),l.add(e),t.classList.add("msg--was-featured"))}}(c);break;case"viewers":break;default:console.log("Unknown tag:",a.tag)}}),g.addEventListener("close",e=>{console.log("[Dashboard] Socket closed. Attempting reconnect.",e.reason),p(!1),setTimeout(()=>{n()},3e3)}),g.addEventListener("error",()=>{g?.close(),p(!1),setTimeout(()=>{n()},3e3)}))};a()}(),document.querySelectorAll(".msg").forEach(e=>{e.addEventListener("click",v),e.closest("#donation-history")&&k(e,parseInt(e.dataset.sentAt||"0",10)||Math.floor(Date.now()/1e3))}),t&&(s=!0,r(t,u)),e&&(o=!0,r(e,d)),document.querySelectorAll(".poll-option").forEach(e=>{e.addEventListener("keydown",w),e.addEventListener("blur",E)}),window.newPollOption=y,window.onPollOptionType=w,window.onPollOptionChange=E,window.onPollCreate=function(){const e=document.getElementById("multiplechoice"),t=document.getElementById("pollquestion"),n=e?.checked?"multipoll":"poll",o=document.querySelectorAll(".poll-option"),s=[],l=t?.value||"";o.forEach(e=>{""!==e.value&&s.push(e.value)}),s.length<2?alert("You need at least two poll options."):""!==l?(L(`!${n} ${l}; ${s.join("; ")}`),function(){const e=document.getElementById("pollquestion");e&&(e.value=""),document.querySelectorAll(".poll-option").forEach(e=>{e.remove()}),y(2)}()):alert("You need a poll question.")},window.onPollEnd=function(){L("!endpoll",!0)},window.sendPaidMessage=function(){const e=new h(A(),"none","none"),t=document.getElementById("donation-platform"),n=document.getElementById("donation-username"),o=document.getElementById("donation-amount"),s=document.getElementById("donation-currency"),l=document.getElementById("donation-message");switch(e.platform=t?.value||"none",e.username=n?.value||"Anonymous",e.amount=parseFloat(o?.value||"0"),e.currency=s?.value||"USD",e.message=l?.value||"",e.platform){case"mail":case"usps":e.avatar="/static/logo/usps.png"}S(e)},window.sendSimpleMessage=L})();