(()=>{"use strict";const t={objectType:"ammo",objectScale:.1,objectSprites:["/static/img/ammo_556_round_a.png","/static/img/ammo_556_round_b.png","/static/img/ammo_556_round_c.png","/static/img/ammo_556_round_d.png"],restitution:.05,friction:.9,frictionAir:.01,density:.002,showLabels:!1,labelColor:"#ffff00",labelFont:"Verlag",labelSize:12,spawnRate:2,spawnDelay:50,maxObjects:500,showAngleIndicator:!1,wireframes:!1,fps:60};class e{constructor(e,i={}){this.objects=[],this.objectPool=[],this.isRunning=!1,this.precomputedVertices=null,this.cachedFontString="",this.frameCount=0,this.BOUNDARY_CHECK_INTERVAL=5,this.labelFrameCount=0,this.LABEL_RENDER_INTERVAL=3,this.spawnQueue=[],this.spawnQueueTimerId=null,this.config={...t,...i},this.viewportWidth=window.innerWidth,this.viewportHeight=window.innerHeight,this.precomputeVertices(),this.updateCachedFont(),this.boundHandleResize=this.handleResize.bind(this),this.boundAfterUpdate=this.onAfterUpdate.bind(this),this.boundAfterRender=this.onAfterRender.bind(this),document.body.style.overflow="hidden",document.body.style.margin="0",document.body.style.padding="0",this.engine=Matter.Engine.create({enableSleeping:!0,positionIterations:6,velocityIterations:4,constraintIterations:2}),this.world=this.engine.world,this.engine.gravity.y=.8,this.render=Matter.Render.create({element:e,engine:this.engine,options:{width:this.viewportWidth,height:this.viewportHeight,showAngleIndicator:this.config.showAngleIndicator,showBounds:!1,showSleeping:!1,wireframes:this.config.wireframes,background:"transparent"}}),this.runner=Matter.Runner.create({delta:1e3/this.config.fps}),this.bottomWall=Matter.Bodies.rectangle(this.viewportWidth/2,this.viewportHeight+25,this.viewportWidth,50,{isStatic:!0,render:{visible:!1}}),this.leftWall=Matter.Bodies.rectangle(-25,this.viewportHeight/2,50,2*this.viewportHeight,{isStatic:!0,render:{visible:!1}}),this.rightWall=Matter.Bodies.rectangle(this.viewportWidth+25,this.viewportHeight/2,50,2*this.viewportHeight,{isStatic:!0,render:{visible:!1}}),Matter.Composite.add(this.world,[this.bottomWall,this.leftWall,this.rightWall]);const s=Matter.Mouse.create(this.render.canvas),n=Matter.MouseConstraint.create(this.engine,{mouse:s,constraint:{stiffness:.2,render:{visible:!1}}});Matter.Composite.add(this.world,n),this.render.mouse=s,this.setupEventHandlers(),window.addEventListener("resize",this.boundHandleResize)}precomputeVertices(){const t=["85 0","105 120","115 200","115 780","105 800","125 850","125 980","45 980","45 850","65 800","55 780","55 200","65 120"].join(" ");this.precomputedVertices=Matter.Vertices.fromPath(t,void 0);const e=this.config.objectScale,i=Matter.Vertices.centre(this.precomputedVertices);this.precomputedVertices=this.precomputedVertices.map(t=>({x:(t.x-i.x)*e,y:(t.y-i.y)*e}))}updateCachedFont(){this.cachedFontString=`${this.config.labelSize}px ${this.config.labelFont}`}setupEventHandlers(){Matter.Events.on(this.engine,"afterUpdate",this.boundAfterUpdate),Matter.Events.on(this.render,"afterRender",this.boundAfterRender)}onAfterUpdate(){this.frameCount++,this.adaptPhysicsIterations(),this.frameCount%this.BOUNDARY_CHECK_INTERVAL===0&&this.checkBoundaries(),this.objects.length>this.config.maxObjects&&this.cleanupExcessObjects()}onAfterRender(){this.config.showLabels&&(this.labelFrameCount++,this.labelFrameCount%this.LABEL_RENDER_INTERVAL===0&&this.renderLabels())}adaptPhysicsIterations(){const t=this.objects.length;t>400?(this.engine.positionIterations=4,this.engine.velocityIterations=2,this.engine.constraintIterations=1):t>200?(this.engine.positionIterations=6,this.engine.velocityIterations=4,this.engine.constraintIterations=2):(this.engine.positionIterations=8,this.engine.velocityIterations=6,this.engine.constraintIterations=3)}checkBoundaries(){for(const t of this.objects){if(!t.active)continue;const e=t.body;if(e.isStatic||e.isSleeping)continue;let i=!1;const s={x:e.position.x,y:e.position.y};e.position.x<0?(s.x=50,i=!0):e.position.x>this.viewportWidth&&(s.x=this.viewportWidth-50,i=!0),e.position.y>this.viewportHeight+100&&(s.y=this.viewportHeight-50,i=!0),i&&(Matter.Body.setVelocity(e,{x:0,y:0}),Matter.Body.setAngularVelocity(e,0),Matter.Body.setPosition(e,s))}}cleanupExcessObjects(){const t=this.objects.length-this.config.maxObjects;if(t<=0)return;let e=0;for(let i=0;i<this.objects.length&&e<t;i++){const t=this.objects[i];t.active&&(this.deactivateObject(t),e++)}this.objects=this.objects.filter(t=>t.active)}deactivateObject(t){t.active=!1,Matter.Composite.remove(this.world,t.body),this.objectPool.length<100&&this.objectPool.push(t)}getPooledObject(t,e,i){let s=this.objectPool.pop();if(s)this.resetBody(s.body,t,e,i),s.username=i,s.active=!0,Matter.Composite.add(this.world,s.body);else{const n=this.createBody(t,e,i);s={body:n,username:i,active:!0},Matter.Composite.add(this.world,n)}return s}createBody(t,e,i){const s=this.precomputedVertices.map(t=>({x:t.x,y:t.y})),n=this.config.objectSprites[Math.floor(Math.random()*this.config.objectSprites.length)],o=Matter.Bodies.fromVertices(t,e,[s],{render:{sprite:{texture:n,xScale:this.config.objectScale,yScale:this.config.objectScale}},restitution:this.config.restitution,friction:this.config.friction,frictionAir:this.config.frictionAir,density:this.config.density,slop:.01,frictionStatic:.9});return i&&this.config.showLabels&&(o.label={text:i,color:this.config.labelColor}),Matter.Body.setAngle(o,Math.random()*Math.PI*2),o}resetBody(t,e,i,s){Matter.Body.setPosition(t,{x:e,y:i}),Matter.Body.setVelocity(t,{x:0,y:0}),Matter.Body.setAngularVelocity(t,0),Matter.Body.setAngle(t,Math.random()*Math.PI*2),t.isSleeping&&Matter.Sleeping.set(t,!1),s&&this.config.showLabels?t.label={text:s,color:this.config.labelColor}:t.label=null;const n=this.config.objectSprites[Math.floor(Math.random()*this.config.objectSprites.length)];t.render.sprite&&(t.render.sprite.texture=n)}renderLabels(){const t=this.render.canvas.getContext("2d");if(t){t.font=this.cachedFontString,t.strokeStyle="#000000",t.lineWidth=2,t.textAlign="center",t.textBaseline="bottom";for(const e of this.objects){if(!e.active)continue;const i=e.body,s=i.label;s?.text&&!i.isStatic&&(t.save(),t.translate(i.position.x,i.position.y),t.rotate(i.angle+Math.PI/2),t.fillStyle=s.color||this.config.labelColor,t.strokeText(s.text,10,6),t.fillText(s.text,10,6),t.restore())}}}handleResize(){const t=window.innerWidth,e=window.innerHeight;this.render.canvas.width=t,this.render.canvas.height=e,this.render.options.width=t,this.render.options.height=e,Matter.Render.lookAt(this.render,{min:{x:0,y:0},max:{x:t,y:e}}),Matter.Body.setPosition(this.bottomWall,{x:t/2,y:e+25}),Matter.Body.scale(this.bottomWall,t/(this.bottomWall.bounds.max.x-this.bottomWall.bounds.min.x),1),Matter.Body.setPosition(this.leftWall,{x:-25,y:e/2}),Matter.Body.scale(this.leftWall,1,2*e/(this.leftWall.bounds.max.y-this.leftWall.bounds.min.y)),Matter.Body.setPosition(this.rightWall,{x:t+25,y:e/2}),Matter.Body.scale(this.rightWall,1,2*e/(this.rightWall.bounds.max.y-this.rightWall.bounds.min.y));for(const i of this.objects){if(!i.active)continue;const s=i.body;if(s.isStatic)continue;const n={x:s.position.x,y:s.position.y};let o=!1;s.position.x>t&&(n.x=t-50,o=!0),s.position.x<0&&(n.x=50,o=!0),s.position.y>e&&(n.y=e-50,o=!0),o&&(Matter.Body.setPosition(s,n),Matter.Body.setVelocity(s,{x:0,y:0}),s.isSleeping&&Matter.Sleeping.set(s,!1))}this.viewportWidth=t,this.viewportHeight=e}start(){this.isRunning||(Matter.Render.run(this.render),Matter.Runner.run(this.runner,this.engine),Matter.Render.lookAt(this.render,{min:{x:0,y:0},max:{x:this.viewportWidth,y:this.viewportHeight}}),this.startSpawnQueue(),this.isRunning=!0)}stop(){this.isRunning&&(Matter.Render.stop(this.render),Matter.Runner.stop(this.runner),this.stopSpawnQueue(),this.isRunning=!1)}startSpawnQueue(){if(null!==this.spawnQueueTimerId)return;const t=()=>{const e=Date.now();for(;this.spawnQueue.length>0&&this.spawnQueue[0].scheduledTime<=e;){const t=this.spawnQueue.shift();this.spawnObjectImmediate(t.x,t.y,t.username)}this.spawnQueueTimerId=requestAnimationFrame(t)};this.spawnQueueTimerId=requestAnimationFrame(t)}stopSpawnQueue(){null!==this.spawnQueueTimerId&&(cancelAnimationFrame(this.spawnQueueTimerId),this.spawnQueueTimerId=null)}spawnObjectImmediate(t,e,i){if(void 0===e&&(e=-100),void 0===t){const e=this.viewportWidth/2,i=this.viewportWidth/2.5,s=2*Math.random()-1;t=e+i*s*s*(s<0?-1:1)}const s=this.getPooledObject(t,e,i);return this.objects.push(s),s.body}spawnObject(t,e,i){this.spawnQueue.push({x:t,y:e,username:i,scheduledTime:Date.now()})}handleDonation(t,e){const i=Math.floor(t*this.config.spawnRate),s=Date.now();for(let t=0;t<i;t++)this.spawnQueue.push({x:void 0,y:void 0,username:e,scheduledTime:s+t*this.config.spawnDelay})}updateConfig(t){this.config={...this.config,...t},this.updateCachedFont(),void 0!==t.objectScale&&this.precomputeVertices()}getConfig(){return{...this.config}}clear(){for(const t of this.objects)t.active&&Matter.Composite.remove(this.world,t.body);this.objects=[],this.objectPool=[],this.spawnQueue=[]}getCanvas(){return this.render.canvas}getObjectCount(){return this.objects.filter(t=>t.active).length}getPoolSize(){return this.objectPool.length}destroy(){this.stop(),this.clear(),window.removeEventListener("resize",this.boundHandleResize),Matter.Events.off(this.engine,"afterUpdate",this.boundAfterUpdate),Matter.Events.off(this.render,"afterRender",this.boundAfterRender),this.render.canvas.parentNode&&this.render.canvas.parentNode.removeChild(this.render.canvas),Matter.Engine.clear(this.engine)}}class i{constructor(t){this.socket=null,this.reconnectTimer=null,this.onDonation=t,this.connect()}connect(){const t=("https:"===window.location.protocol?"wss:":"ws:")+"//"+window.location.host+"/chat.ws";console.log("[Background] Connecting to WebSocket:",t),this.socket=new WebSocket(t),this.socket.addEventListener("open",()=>{console.log("[Background] WebSocket connected")}),this.socket.addEventListener("message",t=>{this.handleMessage(t.data)}),this.socket.addEventListener("close",t=>{console.log("[Background] WebSocket closed:",t.reason),this.scheduleReconnect()}),this.socket.addEventListener("error",()=>{this.socket?.close()})}handleMessage(t){try{const e=JSON.parse(t),i=JSON.parse(e.message);"chat_message"===e.tag&&i.amount>0&&this.onDonation(i.amount,i.username)}catch(t){console.error("[Background] Failed to parse message:",t)}}scheduleReconnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>{console.log("[Background] Attempting reconnect..."),this.connect()},1e3)}destroy(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.socket?.close()}}function s(){const t=document.getElementById("physics-canvas")?.parentElement||document.body,s=function(){const t=window.FRAME_CONFIG;return t&&t.donationMatter?t.donationMatter:{}}(),n=new e(t,s);n.start(),new i((t,e)=>{n.handleDonation(t,e)}),window.donationMatter=n,window.spawnAmmo=(t,e,i)=>n.spawnObject(t,e,i),console.log("[Background] DonationMatter initialized")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s()})();