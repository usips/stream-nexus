(()=>{"use strict";const t={objectType:"ammo",objectScale:.1,objectSprites:["/static/img/ammo_556_round_a.png","/static/img/ammo_556_round_b.png","/static/img/ammo_556_round_c.png","/static/img/ammo_556_round_d.png"],restitution:.05,friction:.9,frictionAir:.01,density:.002,showLabels:!0,labelColor:"#ffff00",labelFont:"Verlag",labelSize:12,spawnRate:2,spawnDelay:50,maxObjects:500,showAngleIndicator:!0,wireframes:!1,fps:24};class e{constructor(e,i={}){this.objects=[],this.isRunning=!1,this.config={...t,...i},this.viewportWidth=window.innerWidth,this.viewportHeight=window.innerHeight,document.body.style.overflow="hidden",document.body.style.margin="0",document.body.style.padding="0",this.engine=Matter.Engine.create({enableSleeping:!0,positionIterations:10,velocityIterations:8,constraintIterations:4}),this.world=this.engine.world,this.engine.gravity.y=.8,this.render=Matter.Render.create({element:e,engine:this.engine,options:{width:this.viewportWidth,height:this.viewportHeight,showAngleIndicator:this.config.showAngleIndicator,showBounds:!1,showSleeping:!1,wireframes:this.config.wireframes,background:"transparent"}}),this.runner=Matter.Runner.create(),this.bottomWall=Matter.Bodies.rectangle(this.viewportWidth/2,this.viewportHeight+25,this.viewportWidth,50,{isStatic:!0,render:{visible:!1}}),this.leftWall=Matter.Bodies.rectangle(-25,this.viewportHeight/2,50,2*this.viewportHeight,{isStatic:!0,render:{visible:!1}}),this.rightWall=Matter.Bodies.rectangle(this.viewportWidth+25,this.viewportHeight/2,50,2*this.viewportHeight,{isStatic:!0,render:{visible:!1}}),Matter.Composite.add(this.world,[this.bottomWall,this.leftWall,this.rightWall]);const o=Matter.Mouse.create(this.render.canvas),s=Matter.MouseConstraint.create(this.engine,{mouse:o,constraint:{stiffness:.2,render:{visible:!1}}});Matter.Composite.add(this.world,s),this.render.mouse=o,this.setupEventHandlers(),window.addEventListener("resize",this.handleResize.bind(this))}setupEventHandlers(){Matter.Events.on(this.engine,"afterUpdate",()=>{this.checkBoundaries(),this.cleanupExcessObjects()}),Matter.Events.on(this.render,"afterRender",()=>{this.config.showLabels&&this.renderLabels()})}checkBoundaries(){const t=Matter.Composite.allBodies(this.world);for(const e of t){if(e.isStatic)continue;let t=!1;const i={x:e.position.x,y:e.position.y};e.position.x<0?(i.x=50,t=!0):e.position.x>this.viewportWidth&&(i.x=this.viewportWidth-50,t=!0),e.position.y>this.viewportHeight&&(i.y=this.viewportHeight-50,t=!0),t&&(Matter.Body.setVelocity(e,{x:0,y:0}),Matter.Body.setAngularVelocity(e,0),Matter.Body.setPosition(e,i),e.isSleeping&&Matter.Sleeping.set(e,!1))}}cleanupExcessObjects(){for(;this.objects.length>this.config.maxObjects;){const t=this.objects.shift();t&&Matter.Composite.remove(this.world,t.body)}}renderLabels(){const t=this.render.canvas.getContext("2d");if(!t)return;const e=Matter.Composite.allBodies(this.world);for(const i of e){const e=i.label;if(e?.text&&!i.isStatic){t.save();const o=i.position.x,s=i.position.y;t.translate(o,s),t.rotate(i.angle+Math.PI/2),t.font=`${this.config.labelSize}px ${this.config.labelFont}`,t.fillStyle=e.color||this.config.labelColor,t.strokeStyle="#000000",t.lineWidth=2,t.textAlign="center",t.textBaseline="bottom",t.strokeText(e.text,10,6),t.fillText(e.text,10,6),t.restore()}}}handleResize(){const t=window.innerWidth,e=window.innerHeight;this.render.canvas.width=t,this.render.canvas.height=e,this.render.options.width=t,this.render.options.height=e,Matter.Render.lookAt(this.render,{min:{x:0,y:0},max:{x:t,y:e}}),Matter.Body.setPosition(this.bottomWall,{x:t/2,y:e+25}),Matter.Body.scale(this.bottomWall,t/(this.bottomWall.bounds.max.x-this.bottomWall.bounds.min.x),1),Matter.Body.setPosition(this.leftWall,{x:-25,y:e/2}),Matter.Body.scale(this.leftWall,1,2*e/(this.leftWall.bounds.max.y-this.leftWall.bounds.min.y)),Matter.Body.setPosition(this.rightWall,{x:t+25,y:e/2}),Matter.Body.scale(this.rightWall,1,2*e/(this.rightWall.bounds.max.y-this.rightWall.bounds.min.y));const i=Matter.Composite.allBodies(this.world);for(const o of i)if(o.isSleeping&&!o.isStatic&&Matter.Sleeping.set(o,!1),!o.isStatic){const i={x:o.position.x,y:o.position.y};let s=!1;o.position.x>t&&(i.x=t-50,s=!0),o.position.x<0&&(i.x=50,s=!0),o.position.y>e&&(i.y=e-50,s=!0),s&&(Matter.Body.setPosition(o,i),Matter.Body.setVelocity(o,{x:0,y:0}))}this.viewportWidth=t,this.viewportHeight=e}start(){this.isRunning||(Matter.Render.run(this.render),Matter.Runner.run(this.runner,this.engine),Matter.Render.lookAt(this.render,{min:{x:0,y:0},max:{x:this.viewportWidth,y:this.viewportHeight}}),this.isRunning=!0)}stop(){this.isRunning&&(Matter.Render.stop(this.render),Matter.Runner.stop(this.runner),this.isRunning=!1)}spawnObject(t,e,i){if(void 0===e&&(e=-100),void 0===t){const e=this.viewportWidth/2,i=this.viewportWidth/2.5,o=2*Math.random()-1;t=e+i*o*o*(o<0?-1:1)}const o=["85 0","105 120","115 200","115 780","105 800","125 850","125 980","45 980","45 850","65 800","55 780","55 200","65 120"].join(" "),s=Matter.Vertices.fromPath(o,void 0),n=this.config.objectSprites[Math.floor(Math.random()*this.config.objectSprites.length)],r=Matter.Bodies.fromVertices(t,e,[s],{render:{sprite:{texture:n,xScale:this.config.objectScale,yScale:this.config.objectScale}},restitution:this.config.restitution,friction:this.config.friction,frictionAir:this.config.frictionAir,density:this.config.density,slop:.01,frictionStatic:.9});return Matter.Body.scale(r,this.config.objectScale,this.config.objectScale),i&&this.config.showLabels&&(r.label={text:i,color:this.config.labelColor}),Matter.Body.setAngle(r,Math.random()*Math.PI*2),Matter.Composite.add(this.world,r),this.objects.push({body:r,username:i}),r}handleDonation(t,e){const i=Math.floor(t*this.config.spawnRate);for(let t=0;t<i;t++)setTimeout(()=>{this.spawnObject(void 0,void 0,e)},t*this.config.spawnDelay)}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}clear(){for(const t of this.objects)Matter.Composite.remove(this.world,t.body);this.objects=[]}getCanvas(){return this.render.canvas}destroy(){this.stop(),this.clear(),window.removeEventListener("resize",this.handleResize.bind(this)),this.render.canvas.parentNode&&this.render.canvas.parentNode.removeChild(this.render.canvas),Matter.Engine.clear(this.engine)}}class i{constructor(t){this.socket=null,this.reconnectTimer=null,this.onDonation=t,this.connect()}connect(){const t=("https:"===window.location.protocol?"wss:":"ws:")+"//"+window.location.host+"/chat.ws";console.log("[Background] Connecting to WebSocket:",t),this.socket=new WebSocket(t),this.socket.addEventListener("open",()=>{console.log("[Background] WebSocket connected")}),this.socket.addEventListener("message",t=>{this.handleMessage(t.data)}),this.socket.addEventListener("close",t=>{console.log("[Background] WebSocket closed:",t.reason),this.scheduleReconnect()}),this.socket.addEventListener("error",()=>{this.socket?.close()})}handleMessage(t){try{const e=JSON.parse(t),i=JSON.parse(e.message);"chat_message"===e.tag&&i.amount>0&&this.onDonation(i.amount,i.username)}catch(t){console.error("[Background] Failed to parse message:",t)}}scheduleReconnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>{console.log("[Background] Attempting reconnect..."),this.connect()},1e3)}destroy(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.socket?.close()}}function o(){const t=document.getElementById("physics-canvas")?.parentElement||document.body,o=function(){const t=window.FRAME_CONFIG;return t&&t.donationMatter?t.donationMatter:{}}(),s=new e(t,o);s.start(),new i((t,e)=>{s.handleDonation(t,e)}),window.donationMatter=s,window.spawnAmmo=(t,e,i)=>s.spawnObject(t,e,i),console.log("[Background] DonationMatter initialized")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o()})();