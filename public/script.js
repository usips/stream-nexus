(()=>{"use strict";const e=document.querySelector("#elements-container"),t=document.querySelector("#show-message");let s=[],n=null;const o={queue:[],maxWaitTime:1e3,minInterval:50,intervalId:null,lastProcessTime:0,push(e){this.queue.push({message:e,timestamp:Date.now()}),this.ensureProcessing()},ensureProcessing(){null===this.intervalId&&this.queue.length>0&&this.scheduleNext()},getProcessCount(){if(0===this.queue.length)return 0;const e=Date.now();let t=0;for(const s of this.queue){if(!(e-s.timestamp>=this.maxWaitTime))break;t++}return 0===t&&this.queue.length>0&&e-this.lastProcessTime>=this.minInterval&&(t=1),t},getDelay(){if(0===this.queue.length)return this.minInterval;const e=Date.now()-this.queue[0].timestamp,t=this.maxWaitTime-e;if(t<=0)return 0;const s=Math.floor(t/this.queue.length);return Math.max(this.minInterval,s)},scheduleNext(){if(0===this.queue.length)return void(this.intervalId=null);const e=this.getDelay();this.intervalId=setTimeout(()=>{this.processBatch(),this.scheduleNext()},e)},processBatch(){if(0===this.queue.length)return;const e=this.getProcessCount();for(let t=0;t<e&&this.queue.length>0;t++){const e=this.queue.shift();e&&m(e.message)}this.lastProcessTime=Date.now()},onVisibilityChange(){"visible"===document.visibilityState&&this.queue.length>0&&(this.processBatch(),null!==this.intervalId&&(clearTimeout(this.intervalId),this.intervalId=null),this.ensureProcessing())}};document.addEventListener("visibilitychange",()=>{o.onVisibilityChange()});const i=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/chat.ws`;let l=new WebSocket(i);const a=()=>l.readyState===WebSocket.OPEN||l.readyState===WebSocket.CONNECTING||(l=new WebSocket(i),r(),!1),r=()=>{l.addEventListener("open",()=>{console.log("[SNEED] Connection established.");const e=window.LAYOUT_NAME;e?(console.log("[SNEED] Subscribing to layout:",e),l.send(JSON.stringify({subscribe_layout:e}))):l.send(JSON.stringify({request_layout:!0}))}),l.addEventListener("message",i=>{const l=JSON.parse(i.data),a=JSON.parse(l.message);switch(l.tag){case"chat_message":!function(e){const t=document.getElementById(e.id);null!==t||(function(e){if(!e.message.startsWith("!")&&null===v)return!1;let t=function(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""}(e.message);const s=e.is_owner;if(t.startsWith("!poll")&&s){t=t.replace("!poll","").trim();let e=t.split(";");return e=e.filter(e=>0!==e.length),e.length>=3&&(v=new S(e[0],!1,e.slice(1))),!0}if(t.startsWith("!multipoll")&&s){t=t.replace("!multipoll","").trim();let e=t.split(";");return e=e.filter(e=>0!==e.length),e.length>=3&&(v=new S(e[0],!0,e.slice(1))),!0}return t.startsWith("!endpoll")&&s?(null!==v&&v.end_poll(),!0):!(null===v||!v.is_valid_vote(e.message))&&(v.handle_vote_message(e),!0)}(e)||(e.amount>0?m(e):o.push(e)))}(a);break;case"feature_message":!function(e){if(t)if(null===e)t.innerHTML="";else{const s=document.getElementById(e);if(null!==s){const n=s.cloneNode(!0);n.id=`feature-${e}`,t.innerHTML=n.outerHTML}else console.log("Featured chat message not found:",e)}}(a);break;case"viewers":!function(e){console.log("VIEWERS",e);for(const[t,s]of Object.entries(e))window.livestream_viewers[t]="number"==typeof s?s:parseInt(s,10);const t=n?.elements||{};for(const[e,s]of Object.entries(t))if("live"===e.replace(/-\d+$/,"")&&!1!==s.enabled){const t=document.getElementById(e),n=t?.querySelector(".live-totals");if(n){const e=s.options,t=y(window.livestream_viewers,e);n.innerHTML=t.toString()}}}(a);break;case"layout_update":!function(t){if(console.log("[SNEED] Applying layout:",t.name),n=t,!e)return void console.error("[SNEED] Elements container not found!");const o=t.elements||{};e.innerHTML="",s=[];for(const[n,i]of Object.entries(o)){if(!i||!1===i.enabled)continue;const o=n.replace(/-\d+$/,""),l=d(n,o,i);if(l&&(e.appendChild(l),h(l,i,"text"===o||"attribution"===o),"chat"===o)){const e=l.querySelector(".chat-messages");if(e){const o=i.options||{},a=t.messageStyle||{},r={showAvatars:o.showAvatars??a.showAvatars??!0,showUsernames:o.showUsernames??a.showUsernames??!0,condensedMode:o.condensedMode??a.condensedMode??!1,direction:o.direction??a.direction??"bottom",showOwnerBadge:o.showOwnerBadge??a.showOwnerBadge??!0,showStaffBadge:o.showStaffBadge??a.showStaffBadge??!0,showModBadge:o.showModBadge??a.showModBadge??!0,showVerifiedBadge:o.showVerifiedBadge??a.showVerifiedBadge??!0,showSubBadge:o.showSubBadge??a.showSubBadge??!0};s.push({container:e,elementId:n,options:r}),l.classList.toggle("chat--condensed",!0===r.condensedMode),l.classList.toggle("chat--no-avatars",!1===r.showAvatars),l.classList.toggle("chat--no-usernames",!1===r.showUsernames),l.classList.toggle("chat--top-first","top"===r.direction)}}}if(t.messageStyle){const e=t.messageStyle,s=document.documentElement;e.avatarSize&&s.style.setProperty("--avatar-size",e.avatarSize),e.maxHeight&&s.style.setProperty("--message-max-height",e.maxHeight),e.borderRadius&&s.style.setProperty("--message-border-radius",e.borderRadius),e.fontSize&&s.style.setProperty("--message-font-size",e.fontSize),e.backgroundColor&&s.style.setProperty("--message-bg",e.backgroundColor),e.textColor&&s.style.setProperty("--message-color",e.textColor),window.badgeSettings={owner:!1!==e.showOwnerBadge,staff:!1!==e.showStaffBadge,mod:!1!==e.showModBadge,verified:!1!==e.showVerifiedBadge,sub:!1!==e.showSubBadge}}const i=Object.entries(o).find(([e])=>"chat"===e||e.startsWith("chat-"))?.[1];if(i?.size?.width){const e=i.size.width,t="number"==typeof e?`${e}px`:e;document.documentElement.style.setProperty("--chat-width",t)}}(a);break;case"layout_list":console.log("[SNEED] Available layouts:",a);break;default:console.log("Unknown tag:",l.tag)}}),l.addEventListener("close",e=>{console.log("[SNEED] Socket has closed. Attempting reconnect.",e.reason),setTimeout(()=>{a()},1e3)}),l.addEventListener("error",()=>{l.close(),setTimeout(()=>{a()},1e3)})};r();let c=null;function d(e,t,s){const n=document.createElement("section");switch(n.id=e,n.className=`element element--${t}`,t){case"chat":n.innerHTML='\n                <div class="chat-messages"></div>\n                <div class="flyout">\n                    <div class="poll-ui"></div>\n                    <div class="superchat-ui"></div>\n                </div>\n            ';break;case"live":const e=s.options,o=!0===e?.showIcon,i=!1!==e?.showLabel,l=!1!==e?.showCount;n.innerHTML=`\n                ${o?'<span class="live-icon live-badge">ðŸ“º</span>':""}\n                ${i?'<span class="live-label live-badge">LIVE</span>':""}\n                ${l?'<span class="live-totals live-badge">0</span>':""}\n            `;break;case"text":case"attribution":const a=s.options?.content||"";n.innerHTML=u(a);break;case"featured":n.className+=" show-message";break;case"poll":n.className+=" poll-ui";break;case"superchat":n.className+=" superchat-ui";break;default:return console.warn(`[SNEED] Unknown element type: ${t}`),null}return n}function u(e){return e?e.replace(/\{\{([a-zA-Z_][a-zA-Z0-9_]*)(?::([^}]*))?\}\}/g,(e,t,s)=>"datetime"===t||"date"===t||"time"===t?function(e,t){const s=(e,t=2)=>e.toString().padStart(t,"0"),n={yyyy:e.getFullYear().toString(),yy:e.getFullYear().toString().slice(-2),MMMM:["January","February","March","April","May","June","July","August","September","October","November","December"][e.getMonth()],MMM:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],MM:s(e.getMonth()+1),M:(e.getMonth()+1).toString(),do:(e=>{const t=["th","st","nd","rd"],s=e%100;return e+(t[(s-20)%10]||t[s]||t[0])})(e.getDate()),dd:s(e.getDate()),d:e.getDate().toString(),EEEE:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()],EEE:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][e.getDay()],HH:s(e.getHours()),H:e.getHours().toString(),hh:s(e.getHours()%12||12),h:(e.getHours()%12||12).toString(),mm:s(e.getMinutes()),m:e.getMinutes().toString(),ss:s(e.getSeconds()),s:e.getSeconds().toString(),a:e.getHours()<12?"AM":"PM"},o=Object.keys(n).sort((e,t)=>t.length-e.length);let i="",l=0;for(;l<t.length;){let e=!1;for(const s of o)if(t.substring(l,l+s.length)===s){i+=n[s],l+=s.length,e=!0;break}e||(i+=t[l],l++)}return i}(new Date,s||function(e){switch(e){case"date":return"MMMM d, yyyy";case"time":return"HH:mm:ss";default:return"yyyy-MM-dd HH:mm:ss"}}(t)):"year"===t?(new Date).getFullYear().toString():e):e}function h(e,t,s=!1){if(e)if(t)if(console.log("[SNEED] Applying config to element:",e.id,t),!1!==t.enabled){if(e.style.display="",s&&void 0!==t.options?.content){const s=u(t.options.content);e.innerHTML=s}if(t.position){const s=t.position,n=e=>"number"==typeof e?`${e}px`:e;e.style.left="auto",e.style.right="auto",e.style.top="auto",e.style.bottom="auto",null!==s.x&&void 0!==s.x&&(e.style.left=n(s.x)),null!==s.y&&void 0!==s.y&&(e.style.top=n(s.y)),null!==s.right&&void 0!==s.right&&(e.style.right=n(s.right)),null!==s.bottom&&void 0!==s.bottom&&(e.style.bottom=n(s.bottom))}if(t.size){const s=t.size;null!==s.width&&void 0!==s.width&&(e.style.width="number"==typeof s.width?`${s.width}px`:s.width),null!==s.height&&void 0!==s.height&&(e.style.height="number"==typeof s.height?`${s.height}px`:s.height),s.maxWidth&&(e.style.maxWidth=s.maxWidth),s.maxHeight&&(e.style.maxHeight=s.maxHeight)}if(t.style){const s=t.style;s.backgroundColor&&(e.style.backgroundColor=s.backgroundColor),s.fontSize&&(e.style.fontSize=s.fontSize),s.fontFamily&&(e.style.fontFamily=s.fontFamily),s.fontWeight&&(e.style.fontWeight=s.fontWeight),s.fontStyle&&(e.style.fontStyle=s.fontStyle),s.color&&(e.style.color=s.color),s.padding&&(e.style.padding=s.padding),s.margin&&(e.style.margin=s.margin),s.borderRadius&&(e.style.borderRadius=s.borderRadius),null!==s.opacity&&void 0!==s.opacity&&(e.style.opacity=s.opacity.toString()),s.transform&&(e.style.transform=s.transform),null!==s.zIndex&&void 0!==s.zIndex&&(e.style.zIndex=s.zIndex.toString())}}else e.style.display="none";else e.style.display="none"}function g(e,t){e.querySelectorAll(".msg-badge").forEach(e=>{const s=e.className.match(/msg-badge--(\w+)/);if(s){const n=s[1];let o=!0;"owner"===n?o=!1!==t.showOwnerBadge:"staff"===n?o=!1!==t.showStaffBadge:"mod"===n?o=!1!==t.showModBadge:"verified"===n?o=!1!==t.showVerifiedBadge:"sub"===n&&(o=!1!==t.showSubBadge),o||(e.style.display="none")}})}function m(e){const t=document.getElementById(e.id);if(null!==t)return t;if(0===s.length)return console.warn("[SNEED] No chat containers available for message"),null;let n=null;for(let t=0;t<s.length;t++){const{container:o,options:i}=s[t],l="top"===i.direction;let a=e.html;!1===i.showUsernames&&(a=a.replace('class="msg','class="msg msg--hide-username'));const r=document.createElement("div");l?o.insertBefore(r,o.firstChild):o.appendChild(r);const c=0===t?e.id:`${e.id}-${t}`;r.outerHTML=a.replace(`id="${e.id}"`,`id="${c}"`);const d=document.getElementById(c);for(d&&(g(d,i),0===t&&(n=d,e.amount>0&&f(d,e)));o.children.length>1e3;)for(let e=l?o.children.length-1:0;l?e>=0:e<o.children.length;l?e--:e++){const t=o.children[e];if(!t.classList.contains("msg--sticky")&&!t.classList.contains("msg--t")){t.remove();break}}const u=o.parentElement;u&&(u.scrollTop=l?0:u.scrollHeight)}return n}function f(e,t){if("USD"===t.currency){e.classList.add("msg--sticky"),p();const s=Math.min(600,6*t.amount);setTimeout(()=>{e.classList.remove("msg--sticky"),p()},1e3*s)}}function y(e,t){const s=t?.platformMode||"all",n=t?.platforms||[];let o=0;for(const[t,i]of Object.entries(e)){const e="number"==typeof i?i:parseInt(i,10)||0;"all"===s||"include"===s&&n.includes(t)?o+=e:"exclude"!==s||n.includes(t)||(o+=e)}return Math.max(0,o)}function p(){const e=document.getElementsByClassName("msg--sticky");let t=5;for(let s=0;s<e.length;s++)t+=e[s].offsetHeight+5;let s=document.documentElement.clientHeight/2;t=t>s?s-t:5;for(let s=0;s<e.length;s++)e[s].style.top=`${t}px`,t+=e[s].scrollHeight+5}c&&clearInterval(c),c=setInterval(()=>{if(n)for(const[e,t]of Object.entries(n.elements||{})){const s=e.replace(/-\d+$/,"");if(("text"===s||"attribution"===s)&&!1!==t.enabled&&t.options?.content){const s=document.getElementById(e);s&&(s.innerHTML=u(t.options.content))}}},1e3),window.livestream_viewers={};let v=null;const w=document.getElementById("poll-ui"),b=document.getElementById("superchat-ui");class S{constructor(e,t,s){this.question=e,this.options=s,this.votes=new Array(s.length).fill(0),this.voters=[],this.multi_vote=t,this.total_votes=0,this.update(),w&&(w.style.display="block",w.classList.remove("fade-out"),w.classList.add("fade-in")),b&&b.classList.add("slide-down")}end_poll(){const e=this.voters.length;let t=`<strong>${this.question}</strong><br><small>${e} participants</small><ul>`,s=0;for(let e=0;e<this.options.length;e++)this.votes[e]>this.votes[s]&&(s=e);for(let e=0;e<this.options.length;e++){let n=0;this.total_votes>0&&(n=this.votes[e]/this.total_votes*100);const o=n.toFixed(2);t+=e===s?`<li><strong>!vote ${e+1}: ${this.options[e]} - ${this.votes[e]} (${o}%)</strong></li>`:`<li>!vote ${e+1}: ${this.options[e]} - ${this.votes[e]} (${o}%)</li>`}w&&(w.innerHTML=t,setTimeout(()=>{w.classList.remove("fade-in"),w.classList.add("fade-out"),setTimeout(()=>{w.style.display="none"},500)},1e4)),v=null}update(){if(!w)return;const e=this.voters.length;let t=`<strong>${this.question}</strong><br><small>${e} participants</small><ul>`;for(let e=0;e<this.options.length;e++){let s=0;this.total_votes>0&&(s=this.votes[e]/this.total_votes*100),t+=`<li>!vote ${e+1}: ${this.options[e]} - ${this.votes[e]} (${s.toFixed(2)}%)</li>`}t+="</ul><small>use !vote [number] to vote</small>",w.innerHTML=t}handle_vote_message(e){if(this.voters.includes(e.username))return;const t=e.message.replace("!vote","").replace("!","").trim();let s=!1;if(this.multi_vote){let e=t.split(" ");e=[...new Set(e)];for(const t of e)s=this.handle_vote(t)||s}else s=this.handle_vote(t);s&&(this.voters.push(e.username),this.update())}handle_vote(e){if(isNaN(parseInt(e)))return!1;const t=parseInt(e)-1;return!(t<0||t>=this.options.length||(this.votes[t]++,this.total_votes++,0))}is_valid_vote(e){return!!e.startsWith("!vote")||1===e.length&&!isNaN(parseInt(e[0]))||!(!e.startsWith("!")||isNaN(parseInt(e[1])))}}!function(e){const t=e.getDate(),s=e.toLocaleString("default",{month:"long"}),n=e.getFullYear(),o=`${s} ${t}${(e=>{if(e>3&&e<21)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}})(t)}, ${n}`,i=document.getElementById("date");i&&(i.innerHTML=o)}(new Date)})();