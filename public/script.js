(()=>{"use strict";const t=document.querySelector("#chat-messages"),e=document.querySelector("#show-message");let s=null;const n={queue:[],maxWaitTime:1e3,minInterval:50,intervalId:null,lastProcessTime:0,push(t){this.queue.push({message:t,timestamp:Date.now()}),this.ensureProcessing()},ensureProcessing(){null===this.intervalId&&this.queue.length>0&&this.scheduleNext()},getProcessCount(){if(0===this.queue.length)return 0;const t=Date.now();let e=0;for(const s of this.queue){if(!(t-s.timestamp>=this.maxWaitTime))break;e++}return 0===e&&this.queue.length>0&&t-this.lastProcessTime>=this.minInterval&&(e=1),e},getDelay(){if(0===this.queue.length)return this.minInterval;const t=Date.now()-this.queue[0].timestamp,e=this.maxWaitTime-t;if(e<=0)return 0;const s=Math.floor(e/this.queue.length);return Math.max(this.minInterval,s)},scheduleNext(){if(0===this.queue.length)return void(this.intervalId=null);const t=this.getDelay();this.intervalId=setTimeout(()=>{this.processBatch(),this.scheduleNext()},t)},processBatch(){if(0===this.queue.length)return;const t=this.getProcessCount();for(let e=0;e<t&&this.queue.length>0;e++){const t=this.queue.shift();t&&d(t.message)}this.lastProcessTime=Date.now()},onVisibilityChange(){"visible"===document.visibilityState&&this.queue.length>0&&(this.processBatch(),null!==this.intervalId&&(clearTimeout(this.intervalId),this.intervalId=null),this.ensureProcessing())}};document.addEventListener("visibilitychange",()=>{n.onVisibilityChange()});const o=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/chat.ws`;let i=new WebSocket(o);const l=()=>i.readyState===WebSocket.OPEN||i.readyState===WebSocket.CONNECTING||(i=new WebSocket(o),r(),!1),r=()=>{i.addEventListener("open",()=>{console.log("[SNEED] Connection established."),i.send(JSON.stringify({request_layout:!0}))}),i.addEventListener("message",t=>{const o=JSON.parse(t.data),i=JSON.parse(o.message);switch(o.tag){case"chat_message":!function(t){const e=document.getElementById(t.id);null!==e||(function(t){if(!t.message.startsWith("!")&&null===m)return!1;let e=function(t){const e=document.createElement("div");return e.innerHTML=t,e.textContent||e.innerText||""}(t.message);const s=t.is_owner;if(e.startsWith("!poll")&&s){e=e.replace("!poll","").trim();let t=e.split(";");return t=t.filter(t=>0!==t.length),t.length>=3&&(m=new p(t[0],!1,t.slice(1))),!0}if(e.startsWith("!multipoll")&&s){e=e.replace("!multipoll","").trim();let t=e.split(";");return t=t.filter(t=>0!==t.length),t.length>=3&&(m=new p(t[0],!0,t.slice(1))),!0}return e.startsWith("!endpoll")&&s?(null!==m&&m.end_poll(),!0):!(null===m||!m.is_valid_vote(t.message))&&(m.handle_vote_message(t),!0)}(t)||(t.amount>0?d(t):n.push(t)))}(i);break;case"feature_message":!function(t){if(e)if(null===t)e.innerHTML="";else{const s=document.getElementById(t);if(null!==s){const n=s.cloneNode(!0);n.id=`feature-${t}`,e.innerHTML=n.outerHTML}else console.log("Featured chat message not found:",t)}}(i);break;case"viewers":!function(t){console.log("VIEWERS",t);for(const[e,s]of Object.entries(t))window.livestream_viewers[e]="number"==typeof s?s:parseInt(s,10);const e=s?.elements||{};for(const[t,s]of Object.entries(e))if("live"===t||t.startsWith("live-")){const e=document.getElementById(t),n=e?.querySelector("#live-totals")||document.getElementById("live-totals");if(n&&!1!==s.enabled){const t=s.options,e=h(window.livestream_viewers,t);n.innerHTML=e.toString()}}if(!s||!e.live){const t=h(window.livestream_viewers,void 0),e=document.getElementById("live-totals");e&&(e.innerHTML=t.toString())}}(i);break;case"layout_update":!function(t){console.log("[SNEED] Applying layout:",t.name),s=t;const e=t.elements||{};c(document.getElementById("chat"),e.chat),c(document.getElementById("live"),e.live);const n=e.text||e.attribution;if(c(document.getElementById("attribution"),n,!0),c(document.getElementById("show-message"),e.featured),c(document.getElementById("poll-ui"),e.poll),c(document.getElementById("superchat-ui"),e.superchat),t.messageStyle){const e=t.messageStyle,s=document.documentElement;e.avatarSize&&s.style.setProperty("--avatar-size",e.avatarSize),e.maxHeight&&s.style.setProperty("--message-max-height",e.maxHeight),e.borderRadius&&s.style.setProperty("--message-border-radius",e.borderRadius),e.fontSize&&s.style.setProperty("--message-font-size",e.fontSize),e.backgroundColor&&s.style.setProperty("--message-bg",e.backgroundColor),e.textColor&&s.style.setProperty("--message-color",e.textColor);const n=document.getElementById("chat");n&&(n.classList.toggle("chat--condensed",!0===e.condensedMode),n.classList.toggle("chat--no-avatars",!1===e.showAvatars)),window.badgeSettings={owner:!1!==e.showOwnerBadge,staff:!1!==e.showStaffBadge,mod:!1!==e.showModBadge,verified:!1!==e.showVerifiedBadge,sub:!1!==e.showSubBadge}}if(e.chat?.size?.width){const t=e.chat.size.width,s="number"==typeof t?`${t}px`:t;document.documentElement.style.setProperty("--chat-width",s)}}(i);break;case"layout_list":console.log("[SNEED] Available layouts:",i);break;default:console.log("Unknown tag:",o.tag)}}),i.addEventListener("close",t=>{console.log("[SNEED] Socket has closed. Attempting reconnect.",t.reason),setTimeout(()=>{l()},1e3)}),i.addEventListener("error",()=>{i.close(),setTimeout(()=>{l()},1e3)})};r();let a=null;function u(t){return t?t.replace(/\{\{([a-zA-Z_][a-zA-Z0-9_]*)(?::([^}]*))?\}\}/g,(t,e,s)=>"datetime"===e||"date"===e||"time"===e?function(t,e){const s=(t,e=2)=>t.toString().padStart(e,"0"),n={yyyy:t.getFullYear().toString(),yy:t.getFullYear().toString().slice(-2),MMMM:["January","February","March","April","May","June","July","August","September","October","November","December"][t.getMonth()],MMM:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()],MM:s(t.getMonth()+1),M:(t.getMonth()+1).toString(),do:(t=>{const e=["th","st","nd","rd"],s=t%100;return t+(e[(s-20)%10]||e[s]||e[0])})(t.getDate()),dd:s(t.getDate()),d:t.getDate().toString(),EEEE:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][t.getDay()],EEE:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][t.getDay()],HH:s(t.getHours()),H:t.getHours().toString(),hh:s(t.getHours()%12||12),h:(t.getHours()%12||12).toString(),mm:s(t.getMinutes()),m:t.getMinutes().toString(),ss:s(t.getSeconds()),s:t.getSeconds().toString(),a:t.getHours()<12?"AM":"PM"},o=Object.keys(n).sort((t,e)=>e.length-t.length);let i="",l=0;for(;l<e.length;){let t=!1;for(const s of o)if(e.substring(l,l+s.length)===s){i+=n[s],l+=s.length,t=!0;break}t||(i+=e[l],l++)}return i}(new Date,s||function(t){switch(t){case"date":return"MMMM d, yyyy";case"time":return"HH:mm:ss";default:return"yyyy-MM-dd HH:mm:ss"}}(e)):"year"===e?(new Date).getFullYear().toString():t):t}function c(t,e,s=!1){if(t&&e)if(console.log("[SNEED] Applying config to element:",t.id,e),!1!==e.enabled){if(t.style.display="",s&&void 0!==e.options?.content){const s=u(e.options.content);t.innerHTML=s}if(e.position){const s=e.position,n=t=>"number"==typeof t?`${t}px`:t;t.style.left="auto",t.style.right="auto",t.style.top="auto",t.style.bottom="auto",null!==s.x&&void 0!==s.x&&(t.style.left=n(s.x)),null!==s.y&&void 0!==s.y&&(t.style.top=n(s.y)),null!==s.right&&void 0!==s.right&&(t.style.right=n(s.right)),null!==s.bottom&&void 0!==s.bottom&&(t.style.bottom=n(s.bottom))}if(e.size){const s=e.size;null!==s.width&&void 0!==s.width&&(t.style.width="number"==typeof s.width?`${s.width}px`:s.width),null!==s.height&&void 0!==s.height&&(t.style.height="number"==typeof s.height?`${s.height}px`:s.height),s.maxWidth&&(t.style.maxWidth=s.maxWidth),s.maxHeight&&(t.style.maxHeight=s.maxHeight)}if(e.style){const s=e.style;s.backgroundColor&&(t.style.backgroundColor=s.backgroundColor),s.fontSize&&(t.style.fontSize=s.fontSize),s.fontFamily&&(t.style.fontFamily=s.fontFamily),s.fontWeight&&(t.style.fontWeight=s.fontWeight),s.fontStyle&&(t.style.fontStyle=s.fontStyle),s.color&&(t.style.color=s.color),s.padding&&(t.style.padding=s.padding),s.margin&&(t.style.margin=s.margin),s.borderRadius&&(t.style.borderRadius=s.borderRadius),null!==s.opacity&&void 0!==s.opacity&&(t.style.opacity=s.opacity.toString()),s.transform&&(t.style.transform=s.transform),null!==s.zIndex&&void 0!==s.zIndex&&(t.style.zIndex=s.zIndex.toString())}}else t.style.display="none"}function d(e){if(!t)return null;const s=document.getElementById(e.id);if(null!==s)return s;let n=document.createElement("div");for(t.appendChild(n),n.outerHTML=e.html,n=document.getElementById(e.id),o=n,window.badgeSettings&&o.querySelectorAll(".msg-badge").forEach(t=>{const e=t.className.match(/msg-badge--(\w+)/);if(e){const s=e[1];window.badgeSettings[s]||(t.style.display="none")}}),e.amount>0&&function(t,e){if("USD"===e.currency){t.classList.add("msg--sticky"),g();const s=Math.min(600,6*e.amount);setTimeout(()=>{t.classList.remove("msg--sticky"),g()},1e3*s)}}(n,e);t.children.length>1e3;)for(let e=0;e<t.children.length;e++){const s=t.childNodes[e];if(!s.classList.contains("msg--sticky")&&!s.classList.contains("msg--t")){s.remove();break}}var o;const i=t.parentElement;return i&&(i.scrollTop=i.scrollHeight),n}function h(t,e){const s=e?.platformMode||"all",n=e?.platforms||[];let o=0;for(const[e,i]of Object.entries(t)){const t="number"==typeof i?i:parseInt(i,10)||0;"all"===s||"include"===s&&n.includes(e)?o+=t:"exclude"!==s||n.includes(e)||(o+=t)}return Math.max(0,o)}function g(){const t=document.getElementsByClassName("msg--sticky");let e=5;for(let s=0;s<t.length;s++)e+=t[s].offsetHeight+5;let s=document.documentElement.clientHeight/2;e=e>s?s-e:5;for(let s=0;s<t.length;s++)t[s].style.top=`${e}px`,e+=t[s].scrollHeight+5}a&&clearInterval(a),a=setInterval(()=>{if(!s)return;const t=s.elements?.text||s.elements?.attribution;if(t&&!1!==t.enabled&&t.options?.content){const e=document.getElementById("attribution");e&&(e.innerHTML=u(t.options.content))}},1e3),window.livestream_viewers={};let m=null;const y=document.getElementById("poll-ui"),f=document.getElementById("superchat-ui");class p{constructor(t,e,s){this.question=t,this.options=s,this.votes=new Array(s.length).fill(0),this.voters=[],this.multi_vote=e,this.total_votes=0,this.update(),y&&(y.style.display="block",y.classList.remove("fade-out"),y.classList.add("fade-in")),f&&f.classList.add("slide-down")}end_poll(){const t=this.voters.length;let e=`<strong>${this.question}</strong><br><small>${t} participants</small><ul>`,s=0;for(let t=0;t<this.options.length;t++)this.votes[t]>this.votes[s]&&(s=t);for(let t=0;t<this.options.length;t++){let n=0;this.total_votes>0&&(n=this.votes[t]/this.total_votes*100);const o=n.toFixed(2);e+=t===s?`<li><strong>!vote ${t+1}: ${this.options[t]} - ${this.votes[t]} (${o}%)</strong></li>`:`<li>!vote ${t+1}: ${this.options[t]} - ${this.votes[t]} (${o}%)</li>`}y&&(y.innerHTML=e,setTimeout(()=>{y.classList.remove("fade-in"),y.classList.add("fade-out"),setTimeout(()=>{y.style.display="none"},500)},1e4)),m=null}update(){if(!y)return;const t=this.voters.length;let e=`<strong>${this.question}</strong><br><small>${t} participants</small><ul>`;for(let t=0;t<this.options.length;t++){let s=0;this.total_votes>0&&(s=this.votes[t]/this.total_votes*100),e+=`<li>!vote ${t+1}: ${this.options[t]} - ${this.votes[t]} (${s.toFixed(2)}%)</li>`}e+="</ul><small>use !vote [number] to vote</small>",y.innerHTML=e}handle_vote_message(t){if(this.voters.includes(t.username))return;const e=t.message.replace("!vote","").replace("!","").trim();let s=!1;if(this.multi_vote){let t=e.split(" ");t=[...new Set(t)];for(const e of t)s=this.handle_vote(e)||s}else s=this.handle_vote(e);s&&(this.voters.push(t.username),this.update())}handle_vote(t){if(isNaN(parseInt(t)))return!1;const e=parseInt(t)-1;return!(e<0||e>=this.options.length||(this.votes[e]++,this.total_votes++,0))}is_valid_vote(t){return!!t.startsWith("!vote")||1===t.length&&!isNaN(parseInt(t[0]))||!(!t.startsWith("!")||isNaN(parseInt(t[1])))}}!function(t){const e=t.getDate(),s=t.toLocaleString("default",{month:"long"}),n=t.getFullYear(),o=`${s} ${e}${(t=>{if(t>3&&t<21)return"th";switch(t%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}})(e)}, ${n}`,i=document.getElementById("date");i&&(i.innerHTML=o)}(new Date)})();